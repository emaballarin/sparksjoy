#!/usr/bin/env bash
#
# create_user.sh - Create new unprivileged users on DGX Spark systems
#
# Usage:
#   sudo ./create_user.sh [username]
#
# This script creates a new user with:
# - Home directory populated from system skeleton (/etc/skel)
# - Bash as default shell
# - Random temporary password
#
# Requires: sudo/wheel group membership

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Error handler
error_exit() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

# Check if running as root
if [[ $EUID -ne 0 ]]; then
   error_exit "This script must be run as root (use sudo)"
fi

# Function to generate random password
generate_password() {
    tr -dc 'A-Za-z0-9!@#$%^&*' < /dev/urandom | head -c 16
}

# Function to validate username
validate_username() {
    local username=$1

    # Check username format (alphanumeric, dash, underscore; starts with letter or underscore)
    if ! [[ "$username" =~ ^[a-z_][a-z0-9_-]*$ ]]; then
        return 1
    fi

    # Check username length (max 32 chars)
    if [[ ${#username} -gt 32 ]]; then
        return 1
    fi

    # Check if user already exists
    if id "$username" &>/dev/null; then
        echo -e "${RED}User '$username' already exists${NC}" >&2
        return 1
    fi

    return 0
}

# Get username from argument or prompt
if [[ $# -eq 0 ]]; then
    # Interactive mode
    echo -e "${YELLOW}Interactive user creation${NC}"
    echo
    while true; do
        read -p "Enter username: " USERNAME
        if validate_username "$USERNAME"; then
            break
        else
            echo -e "${RED}Invalid username. Must start with letter/underscore, contain only lowercase letters, numbers, dashes, or underscores, and be max 32 characters.${NC}"
        fi
    done
else
    # Command-line mode
    USERNAME=$1
    if ! validate_username "$USERNAME"; then
        error_exit "Invalid username '$USERNAME'. Must start with letter/underscore, contain only lowercase letters, numbers, dashes, or underscores, and be max 32 characters."
    fi
fi

# Generate random password
PASSWORD=$(generate_password)

echo
echo -e "${YELLOW}Creating user '$USERNAME'...${NC}"

# Create user with home directory and default shell
if useradd -m -s /bin/bash "$USERNAME"; then
    echo -e "${GREEN}✓ User created successfully${NC}"
else
    error_exit "Failed to create user"
fi

# Set password
if echo "$USERNAME:$PASSWORD" | chpasswd; then
    echo -e "${GREEN}✓ Password set${NC}"
else
    error_exit "Failed to set password"
fi

# Display credentials
echo
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}User created successfully!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo
echo -e "  Username: ${YELLOW}$USERNAME${NC}"
echo -e "  Password: ${YELLOW}$PASSWORD${NC}"
echo
echo -e "${YELLOW}⚠ Important:${NC}"
echo -e "  - Share this password securely with the user"
echo -e "  - User should change password on first login using: ${GREEN}passwd${NC}"
echo -e "  - This password will not be displayed again"
echo
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo

# Verify home directory was created
if [[ -d "/home/$USERNAME" ]]; then
    echo -e "${GREEN}✓ Home directory created: /home/$USERNAME${NC}"
else
    echo -e "${RED}⚠ Warning: Home directory not found${NC}"
fi

exit 0
